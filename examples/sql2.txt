 select
     t1.julian_date,
	     t1.city_name_en,
		     t1.category_name_en,
			     t1.acc_rev,
				     t1.num,
					     t3.price

						 from
						     (
							    select
								    ding.city_name_en,
									    ding.category_name_en,
										    ding.rev_ding+ji.rev_ji as cash_rev

											from
											        ( 
													         select
															         t1.city_name_en,
																	         t1.category_name_en,
																			         coalesce(rev_ding1,0)+coalesce(rev_ding2,0) as rev_ding
																					         from
																							             (select
																										                  city_name_en,
																														                  category_name_en,
																																		                  sum(total_money) as rev_ding1
																																						              from
																																									                  dds.vw_fact_order
																																													              where
																																																                   julian_pay_date between '20140101'  and '20140425' and service_type_id =5 and status_id<>1 and total_money>0 
																																																				               group by
																																																							                   city_name_en,
																																																											                   category_name_en) t1
																										     
																										         left join

																												         (select
																														                  city_name_en,
																																		                  category_name_en,
																																						                  sum(total_money) as rev_ding2
																																										              from
																																													                  dds.vw_fact_order
																																																	              where
																																																				                   service_type_id =5 and status_id<>1 and total_money>0  and 
																																																								                    order_id in
																																																													                 (
																																																																	                   --筛选出某一天的普通置顶的order_id
																																																																					                       select
																																																																										                       order_id
																																																																															                       from
																																																																																				                       (
																																																																																										                        --这个子查询取出keys只有一个元素的记录
																																																																																																                        select
																																																																																																						                            order_id,
																																																																																																													                            t.attris::text,
																																																																																																																				                            sum(1) as keys
																																																																																																																											                        from
																																																																																																																																	                        (
																																																																																																																																							                             select
																																																																																																																																														                             	a.order_id,
																																																																																																																																																						                            	a.attris,
																																																																																																																																																														                            	json_object_keys(attris->0->'keys') as keys
																																																																																																																																																																						                            from dds.fact_order_additions as a
																																																																																																																																																																													                            inner join dds.fact_order as b on a.order_id = b.order_id and a.julian_created_date =b.julian_pay_date
																																																																																																																																																																																				                            where 
																																																																																																																																																																																											                                julian_created_date >= '20140101' and
																																																																																																																																																																																																			                                b.service_type_id =5 and
																																																																																																																																																																																																											                                a.attris::text like '%[%' and
																																																																																																																																																																																																																			                                case when json_array_length(attris) = 1 then 1 else 0 end = 1
																																																																																																																																																																																																																											                        ) as t
																																																																																																																																							                        group by
																																																																																									                               order_id,
																																																																																																                               t.attris::text
																																																																																																							                           having
																																																																																																													                               sum(1) = 1
																																																																																																																				                       ) as t
																																																																																																																									                       left join dds.dim_city as c on attris::json->0->>'city' = c.city_name_en
																																																																																																																														                       left join dds.dim_object as b on attris::json->0->'keys'->'areas'->>0 = b.id
																																																																																																																																			                       where
																																																																																																																																								                           json_array_length(attris::json->0->'keys'->'areas') = 1 and --keys只有一个记录并且是areas
																																																																																																																																														                           c.city_name_cn = b.name --areas里的meta和city是同一个城市
																																																																																																																																																				                    
																																																																																																																																																				                    )
																																																																																																																																																									            group by
																																																																																																																																																												                city_name_en,
																																																																																																																																																																                category_name_en
																																																																																																																																																																				        ) as t2  on t1.city_name_en=t2.city_name_en and t1.category_name_en = t2.category_name_en 
																																																																																																																																																																						) as ding 

																																																																																																																																																																						    inner join
																																																																																																																																																																							        (
																																																																																																																																																																									             select
																																																																																																																																																																												                 city_name_en,
																																																																																																																																																																																                 category_name_en,
																																																																																																																																																																																				                 sum(total_money) as rev_ji
																																																																																																																																																																																								             from
																																																																																																																																																																																											                 dds.vw_fact_order
																																																																																																																																																																																															             where
																																																																																																																																																																																																		                  julian_pay_date >='20140101' and service_type_id =28 and status_id<>1 and total_money>0 
																																																																																																																																																																																																						              group by
																																																																																																																																																																																																									                  city_name_en,
																																																																																																																																																																																																													                  category_name_en
																																																																																																																																																																																																																	          ) as ji on ding.city_name_en=ji.city_name_en and ding.category_name_en=ji.category_name_en 

																																																																																																																																																																									order by
																																																																																																																																																																									   cash_rev desc
																																																																																																																																																																									      limit 500
																																																																																																																																																																										          ) as t2


																																																																																																																																																																												      left join
																																																																																																																																																																													      (
																																																																																																																																																																														       select
																																																																																																																																																																															       ding.julian_date,
																																																																																																																																																																																       ding.city_name_en,
																																																																																																																																																																																	       ding.category_name_en,
																																																																																																																																																																																		       ding.acc_rev_ding+ji.acc_rev_ji as acc_rev,
																																																																																																																																																																																			       ding.num_ding+ji.num_ji as num

																																																																																																																																																																																				      from
																																																																																																																																																																																					      (select 
																																																																																																																																																																																						           julian_date,
																																																																																																																																																																																								           city_name_en,
																																																																																																																																																																																										           category_name_en,
																																																																																																																																																																																												           sum(accrual_price) as acc_rev_ding,
																																																																																																																																																																																														           count(distinct order_id) as num_ding
																																																																																																																																																																																																       from
																																																																																																																																																																																																	            dds.vw_fact_order_accrual 
																																																																																																																																																																																																				    where
																																																																																																																																																																																																					        julian_date  between v_start_date and v_end_date and service_type_id =5 and status_id<>1 and price>0 and
																																																																																																																																																																																																							        order_id in 
																																																																																																																																																																																																									        (
																																																																																																																																																																																																											         
																																																																																																																																																																																																											         --筛选出某一天的普通置顶的order_id
																																																																																																																																																																																																													             select
																																																																																																																																																																																																																             order_id
																																																																																																																																																																																																																			             from
																																																																																																																																																																																																																						             (
																																																																																																																																																																																																																									                  --这个子查询取出keys只有一个元素的记录
																																																																																																																																																																																																																													                  select
																																																																																																																																																																																																																																	                      order_id,
																																																																																																																																																																																																																																						                      t.attris::text,
																																																																																																																																																																																																																																											                      sum(1) as keys
																																																																																																																																																																																																																																																                  from
																																																																																																																																																																																																																																																				                  (
																																																																																																																																																																																																																																																								                       select
																																																																																																																																																																																																																																																													                       	a.order_id,
																																																																																																																																																																																																																																																																			                    	a.attris,
																																																																																																																																																																																																																																																																									                    	json_object_keys(attris->0->'keys') as keys
																																																																																																																																																																																																																																																																															                    from dds.fact_order_additions as a
																																																																																																																																																																																																																																																																																				                    inner join dds.fact_order_accrual as b on a.order_id = b.order_id and a.julian_created_date =b.julian_start_date
																																																																																																																																																																																																																																																																																									                    where 
																																																																																																																																																																																																																																																																																														                        julian_created_date >= '20140101' and
																																																																																																																																																																																																																																																																																																				                        b.service_type_id =5 and
																																																																																																																																																																																																																																																																																																										                        a.attris::text like '%[%' and
																																																																																																																																																																																																																																																																																																																                        case when json_array_length(attris) = 1 then 1 else 0 end = 1
																																																																																																																																																																																																																																																																																																																						                ) as t
																																																																																																																																																																																																																																																								                  group by
																																																																																																																																																																																																																									                     order_id,
																																																																																																																																																																																																																														                     t.attris::text
																																																																																																																																																																																																																																			                 having
																																																																																																																																																																																																																																							                     sum(1) = 1
																																																																																																																																																																																																																																												             ) as t
																																																																																																																																																																																																																																															             left join dds.dim_city as c on attris::json->0->>'city' = c.city_name_en
																																																																																																																																																																																																																																																		             left join dds.dim_object as b on attris::json->0->'keys'->'areas'->>0 = b.id
																																																																																																																																																																																																																																																					             where
																																																																																																																																																																																																																																																								                 json_array_length(attris::json->0->'keys'->'areas') = 1 and --keys只有一个记录并且是areas
																																																																																																																																																																																																																																																												                 c.city_name_cn = b.name --areas里的meta和city是同一个城市
																																																																																																																																																																																																																																																																         
																																																																																																																																																																																																																																																																         
																																																																																																																																																																																																																																																																         )
																																																																																																																																																																																																																																																																		     group by
																																																																																																																																																																																																																																																																			         julian_date,
																																																																																																																																																																																																																																																																					         city_name_en,
																																																																																																																																																																																																																																																																							         category_name_en) as ding
																																																																																																																																																																																																																																																																									     
																																																																																																																																																																																																																																																																									     inner join
																																																																																																																																																																																																																																																																										     (
																																																																																																																																																																																																																																																																											          select 
																																																																																																																																																																																																																																																																													          julian_date,
																																																																																																																																																																																																																																																																															          city_name_en,
																																																																																																																																																																																																																																																																																	          category_name_en,
																																																																																																																																																																																																																																																																																			          sum(accrual_price) as acc_rev_ji,
																																																																																																																																																																																																																																																																																					          count(distinct order_id) as num_ji
																																																																																																																																																																																																																																																																																							      from
																																																																																																																																																																																																																																																																																								           dds.vw_fact_order_accrual 
																																																																																																																																																																																																																																																																																										       where
																																																																																																																																																																																																																																																																																											           julian_date  between v_start_date and v_end_date and service_type_id =28 and status_id<>1 and price>0
																																																																																																																																																																																																																																																																																													       group by
																																																																																																																																																																																																																																																																																														          julian_date,
																																																																																																																																																																																																																																																																																																         city_name_en,
																																																																																																																																																																																																																																																																																																		        category_name_en
																																																																																																																																																																																																																																																																																																				       
																																																																																																																																																																																																																																																																																																				        ) as ji on ding.julian_date=ji.julian_date and ding.city_name_en=ji.city_name_en and ding.category_name_en=ji.category_name_en
																																																																																																																																																																																																																																																																											     
																																																																																																																																																																																																																																																																											     ) as t1 on t1.city_name_en=t2.city_name_en and t1.category_name_en = t2.category_name_en 
																																																																																																																																																																																																																																																																												     
																																																																																																																																																																																																																																																																												      left join
																																																																																																																																																																																																																																																																													      (
																																																																																																																																																																																																																																																																														       select
																																																																																																																																																																																																																																																																															           julian_created_date,
																																																																																																																																																																																																																																																																																	           city as city_name_en,
																																																																																																																																																																																																																																																																																			           category as category_name_en,
																																																																																																																																																																																																																																																																																					           PRICE*7 as price
																																																																																																																																																																																																																																																																																							       from 
																																																																																																																																																																																																																																																																																								           dds.fact_price_history
																																																																																																																																																																																																																																																																																										       where 
																																																																																																																																																																																																																																																																																											           service_type_id =5 and  julian_created_date  between v_start_date and v_end_date
																																																																																																																																																																																																																																																																																													       ) as t3 on t3.city_name_en=t2.city_name_en and t3.category_name_en = t2.category_name_en and t1.julian_date=t3.julian_created_date

																																																																																																																																																																																																																																																																														    ;
