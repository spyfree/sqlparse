select  A.julian_created_date as 日期,
                A.card_id as 一卡通卡号,
                       A.user_id as 用户编号,
                              round(abs(A.money)/100.0,2) as 金额,
                                     A.order_id as 订单编号,
                                            E.service_type as 服务类型,
                                                   B.num as 有效天数,
                                                          round(B.price/100.0,2) as 订单金额,
                                                                 D.category_name_cn as 类目,
                                                                        C.sales as 销售编号,
                                                                               COALESCE(F.place, G.agent_city_cn) as 渠道, 
                                                                                      COALESCE(F.name, G.agent_bak1) as 销售姓名,
                                                                                             case when ((B.pass_1 = '符合条件_1' and  G.agent_city_cn <> '上海代理商') or (B.pass_2 = '符合条件_2' and G.agent_city_cn = '上海代理商')) then '已算业绩'
                                                                                                    else '未算业绩'
                                                                                                           end 是否已算业绩
                                                                                                           from
                                                                                                           (select 
                                                                                                                card_id,
                                                                                                                    order_id,
                                                                                                                        money,
                                                                                                                            user_id,
                                                                                                                                julian_created_date
                                                                                                                                from dds.fact_card_log
                                                                                                                                where money<0 and julian_created_date >= '20140401'
                                                                                                           ) as A
                                                                                                           left join
                                                                                                           (select
                                                                                                                ad_id,
                                                                                                                    service_type_id,
                                                                                                                        status_id,
                                                                                                                            num,
                                                                                                                                city_id,
                                                                                                                                    city_name_en,
                                                                                                                                        category_name_en,
                                                                                                                                            top_category_name_en,
                                                                                                                                                total_money,
                                                                                                                                                    money,
                                                                                                                                                        card_money,
                                                                                                                                                            coupon_money,
                                                                                                                                                                total_refunded_money,
                                                                                                                                                                    refunded_money,
                                                                                                                                                                        card_refunded_money,
                                                                                                                                                                            price,
                                                                                                                                                                                bak_int,
                                                                                                                                                                                    order_id,
                                                                                                                                                                                        case when (total_money <> 0 and 
                                                                                                                                                                                                  card_money <> 0 and 
                                                                                                                                                                                                      julian_pay_date >= '20140401' and 
                                                                                                                                                                                                          status_id <> 1 and
                                                                                                                                                                                                              (
                                                                                                                                                                                                                            (service_type_id = 5 and
                                                                                                                                                                                                                                             num >= 30) or 
                                                                                                                                                                                                                                            (service_type_id = 28 and
                                                                                                                                                                                                                                                             num >=7) or
                                                                                                                                                                                                                                                            (service_type_id = 19 and
                                                                                                                                                                                                                                                                             num >=7) or
                                                                                                                                                                                                                                                                            (service_type_id = 20 and
                                                                                                                                                                                                                                                                                             num >=7) or
                                                                                                                                                                                                                                                                                            (service_type_id = 29) or
                                                                                                                                                                                                                                                                                                            (service_type_id = 58 and
                                                                                                                                                                                                                                                                                                                            num =7) or
                                                                                                                                                                                                                                                                                                                            (service_type_id = 201 and
                                                                                                                                                                                                                                                                                                                                             price/100 > 100)
                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                  )) then '符合条件_1'
                                                                                                                                                                                              else '其他'
                                                                                                                                                                                                    end pass_1,
                                                                                                                                                                                                          case when (total_money <> 0 and 
                                                                                                                                                                                                                          card_money <> 0 and 
                                                                                                                                                                                                                                julian_pay_date >= '20140401' and 
                                                                                                                                                                                                                                        status_id <> 1 and
                                                                                                                                                                                                                                              (
                                                                                                                                                                                                                                                            (service_type_id = 5 and
                                                                                                                                                                                                                                                                             num >= 90) or 
                                                                                                                                                                                                                                                                            (service_type_id = 28 and
                                                                                                                                                                                                                                                                                             num >=30) or
                                                                                                                                                                                                                                                                                            (service_type_id = 19 and
                                                                                                                                                                                                                                                                                                             num >=7) or
                                                                                                                                                                                                                                                                                                            (service_type_id = 29) or
                                                                                                                                                                                                                                                                                                                            (service_type_id = 58 and
                                                                                                                                                                                                                                                                                                                                             num =7) or
                                                                                                                                                                                                                                                                                                                                            (service_type_id = 201 and
                                                                                                                                                                                                                                                                                                                                                             price/100 > 300)
                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                  )) then '符合条件_2'
                                                                                                                                                                                                                else '其他'
                                                                                                                                                                                                                      end pass_2
                                                                                                                                                                                                                      from dds.fact_order
                                                                                                                                                                                                                      where bak_int = 6 and status_id <> 1 and julian_pay_date >= '20140401'
                                                                                                                                                                                                                      ) as B on A.order_id = B.order_id left join (select id,
                                                                                                                                                                                                                                                                              sales
                                                                                                                                                                                                                                                                                                                          from dds.fact_card
                                                                                                                                                                                                                                                                                                                                                                      where sales <> ' ' and julian_created_date>='20140401' ) as C on A.card_id = C.id left join (select 
                                                                                                                                                                                                                                                                                                                                                                                     right(saleid,4) as sale_id,                         --DianXiao and VIP sale id insert
                                                                                                                                                                                                                                                                                                                                                                                             name, 
                                                                                                                                                                                                                                                                                                                                                                                                              case when left(right(saleid,4),1) = '6' then 'VIP'
                                                                                                                                                                                                                                                                                                                                                                                                                          when left(right(saleid,4),1) = '1' then '上海微创电销'
                                                                                                                                                                                                                                                                                                                                                                                                                                      when left(right(saleid,4),1) = '2' then '苏州微创电销'
                                                                                                                                                                                                                                                                                                                                                                                                                                                  when left(right(saleid,4),1) = '3' then 'OpusOne电销'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                   else '其他'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    end place
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                from dds.dim_customer_sales 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            where status = 'active' and 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        left(right(saleid,4),1) <> '7') as F on C.sales = F.sale_id 
                                                                                                                                                                                                                                                                                                                                                                       left join (select 
                                                                                                                                                                                                                                                                                                                                                                                      case when agent_city = 'shanghai' then '上海代理商'
                                                                                                                                                                                                                                                                                                                                                                                                   when agent_city = 'jinan' then '济南代理商'
                                                                                                                                                                                                                                                                                                                                                                                                               when agent_city = 'zhengzhou' then '郑州代理商'
                                                                                                                                                                                                                                                                                                                                                                                                                           when agent_city = 'xuzhou' then '徐州代理商'
                                                                                                                                                                                                                                                                                                                                                                                                                                  else '其他代理'
                                                                                                                                                                                                                                                                                                                                                                                                                                          end agent_city_cn,                                              --Qudao sale id insert
                                                                                                                                                                                                                                                                                                                                                                                                                                                            cast(agent_id as text) as cast_agent_id, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              agent_bak1 from dds.dim_agent) as G on C.sales = G.cast_agent_id left join (select category_name_en,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      category_name_cn
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      from dds.dim_category
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ) as D on D.category_name_en = B.category_name_en left join (select service_type_id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      service_type
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          from dds.dim_service_type) as E on E.service_type_id = B.service_type_id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          where B.order_id is not null and C.sales is not null and E.service_type in ('置顶','十万火急','全国置顶','全省置顶','智能插播','超级刷新','首页推广','套餐包')
